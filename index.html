<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaia Dominium - MVP</title>
    <style>
        /* Vari√°veis CSS */
        :root {
            --color-primary: #32b8c6;
            --color-primary-dark: #1d7480;
            --color-bg: #1a1a1a;
            --color-surface: #252525;
            --color-card: #333333;
            --color-text: #e0e0e0;
            --color-text-secondary: #a0a0a0;
            --color-accent: #4caf50;
            --color-accent-dark: #2e7d31;
            --color-danger: #e57373;
        }

        /* Estilos Globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--color-surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primary);
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
            border-radius: 6px;
        }

        .icon-btn:hover {
            color: var(--color-primary);
        }

        /* Main Content Layout */
        .main-content {
            display: flex;
            padding-top: 50px; /* Offset for fixed header */
            width: 100%;
            height: calc(100vh - 50px);
        }

        /* Painel Lateral (Info & A√ß√µes) */
        .sidebar-panel {
            width: 300px;
            min-width: 250px;
            background-color: var(--color-surface);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            border-right: 1px solid #3a3a3a;
        }

        .card {
            background-color: var(--color-card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .card h3 {
            border-bottom: 2px solid var(--color-primary-dark);
            padding-bottom: 5px;
            margin-bottom: 10px;
            color: var(--color-primary);
            font-size: 1.1rem;
        }

        /* Se√ß√£o de Recursos */
        .recursos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .recurso-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background-color: #444;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .recurso-item .valor {
            font-weight: bold;
            color: var(--color-accent);
        }

        /* Se√ß√£o de A√ß√µes */
        .actions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-bg);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background-color: #555;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Bot√£o Unidade */
        .btn-action-unit {
            background-color: var(--color-accent);
            color: var(--color-bg);
        }
        .btn-action-unit:hover {
            background-color: var(--color-accent-dark);
        }

        /* Painel do Mapa (Visualiza√ß√£o Central) */
        .map-panel {
            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #1f1f1f; /* Cor de fundo ligeiramente mais escura */
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            width: 80vh; /* Ajuste para ter uma visualiza√ß√£o mais quadrada e adapt√°vel */
            height: 80vh;
            max-width: 900px;
            max-height: 900px;
            gap: 5px; /* Espa√ßamento entre as regi√µes para melhor visualiza√ß√£o */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 4px solid var(--color-primary-dark);
            border-radius: 12px;
            background-color: #111;
        }

        .region {
            background-color: #4a4a4a; /* Cor base neutra */
            border: 1px solid #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            font-size: 0.75rem;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .region:hover {
            transform: scale(1.03);
            box-shadow: 0 0 10px rgba(50, 184, 198, 0.5);
        }

        /* Estilos espec√≠ficos para o tipo de bioma */
        .bioma-floresta { background-color: #2e7d32; } /* Verde Escuro */
        .bioma-savana { background-color: #c09f3e; } /* Ouro/Marrom */
        .bioma-pantano { background-color: #455a64; } /* Cinza Azulado */
        .bioma-temperada { background-color: #6a8b3e; } /* Verde mais suave */

        /* Indicador do Jogador que Controla a Regi√£o */
        .region.controlada {
            border: 3px solid transparent;
        }

        .region-id {
            font-weight: bold;
            margin-bottom: 2px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Estilo da Unidade */
        .unit-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            z-index: 5;
        }

        /* Modal Overlay - Base para Customiza√ß√£o e Manual */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        /* Customiza√ß√£o do Jogador */
        .custom-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .color-selector, .icon-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option, .icon-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: border-color 0.2s;
        }

        .color-option.selected, .icon-option.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 8px var(--color-primary);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1001;
            font-size: 1.5rem;
            border-radius: 10px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Adicionando a fonte Inter e Emojis/√çcones -->
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho (Fixo) -->
        <header class="header">
            <div class="logo">Gaia Dominium</div>
            <div>
                <button class="icon-btn" id="configIcon" title="Configura√ß√µes do Jogador">‚öôÔ∏è</button>
                <button class="icon-btn" id="manualIcon" title="Manual do Jogo">üìö</button>
            </div>
        </header>

        <!-- Conte√∫do Principal -->
        <div class="main-content">
            <!-- Painel de Informa√ß√µes e A√ß√µes -->
            <aside class="sidebar-panel">

                <!-- Info do Jogador Atual -->
                <div class="card" id="player-info-card">
                    <h3>
                        <span id="player-icon"></span>
                        <span id="player-display-name">Carregando...</span>
                    </h3>
                    <p>ID do Jogador: <span id="user-id-display">N/A</span></p>
                    <p>Turno Atual: <span id="current-turn">0</span></p>
                    <p>Pontos de Vit√≥ria: <span id="player-vp">0</span></p>
                </div>

                <!-- Recursos -->
                <div class="card">
                    <h3>Recursos</h3>
                    <div class="recursos-grid">
                        <div class="recurso-item"><span>ü™µ Madeira:</span> <span class="valor" id="res-madeira">0</span></div>
                        <div class="recurso-item"><span>ü™® Pedra:</span> <span class="valor" id="res-pedra">0</span></div>
                        <div class="recurso-item"><span>ü™ô Ouro:</span> <span class="valor" id="res-ouro">0</span></div>
                        <div class="recurso-item"><span>üíß √Ågua:</span> <span class="valor" id="res-agua">0</span></div>
                    </div>
                </div>

                <!-- A√ß√µes -->
                <div class="card">
                    <h3>A√ß√µes de Turno</h3>
                    <div class="actions-grid">
                        <!-- A√ß√£o de Unidade adicionada -->
                        <button class="btn btn-action-unit" id="placeUnitBtn" disabled onclick="colocarUnidade()">‚ûï Colocar Explorador (Custo: 5ü™µ)</button>
                        
                        <button class="btn btn-primary" id="construirBtn" disabled onclick="executarAcao('construir')">üèóÔ∏è Construir</button>
                        <button class="btn btn-primary" id="recolherBtn" disabled onclick="executarAcao('recolher')">Gather Recurso</button>
                        <button class="btn btn-primary" id="negociarBtn" disabled onclick="executarAcao('negociar')">ü§ù Negociar</button>
                    </div>
                </div>
                
                <!-- Fim do Turno -->
                <div class="card">
                    <h3>Controle de Turno</h3>
                    <button class="btn btn-danger" id="endTurnBtn" onclick="passarTurno()">‚ñ∂Ô∏è Passar Turno</button>
                </div>

            </aside>

            <!-- Painel do Mapa -->
            <main class="map-panel">
                <h2>Visualiza√ß√£o de Dom√≠nio Gaia</h2>
                <div class="map-grid" id="map-grid">
                    <!-- Regi√µes ser√£o inseridas aqui pelo JS -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Overlay para Manual -->
    <div class="modal-overlay" id="manualOverlay">
        <div class="modal-content">
             <div class="loading-overlay" id="loadingOverlayManual">
                <div class="spinner"></div>
                Carregando Manual...
            </div>
            <div class="modal-header">
                <h2>Manual do Jogo: Gaia Dominium</h2>
                <button class="modal-close" onclick="fecharManual()">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <div class="tabs-header">
                    <button class="modal-tab active" onclick="mudarAba('tab-visao')">Vis√£o Geral</button>
                    <button class="modal-tab" onclick="mudarAba('tab-acoes')">A√ß√µes</button>
                    <button class="modal-tab" onclick="mudarAba('tab-estrategia')">Estrat√©gia</button>
                </div>
                <!-- Conte√∫do das Abas (Recuperado do seu PDF, adaptado para Markdown) -->
                <div id="tab-visao" class="modal-section active">
                    <p>Gaia Dominium √© um jogo de tabuleiro digital estrat√©gico que combina elementos de Eurogames (gerenciamento de recursos, engine building) com Ameritrash (a√ß√£o din√¢mica, intera√ß√£o entre jogadores). Cada jogador controla uma Fac√ß√£o buscando expandir seu dom√≠nio florestal, gerenciar recursos escassos e acumular Pontos de Vit√≥ria para conquistar o controle sobre o planeta.</p>
                    <br>
                    <h4>Componentes Principais</h4>
                    <ul>
                        <li>**Fac√ß√µes:** Cada jogador representa uma fac√ß√£o √∫nica com cores e √≠cones distintos.</li>
                        <li>**Mapa Florestal:** Um grid dividido em 25 regi√µes, cada uma com Bioma (Tropical, Temperada, Savana, P√¢ntano).</li>
                        <li>**Recursos:** Madeira, Pedra, Ouro, √Ågua.</li>
                    </ul>
                </div>
                <div id="tab-acoes" class="modal-section">
                    <h4>A√ß√µes Modulares</h4>
                    <ul>
                        <li>**Construir:** Gaste Madeira e Pedra para erguer estruturas que aumentam a renda.</li>
                        <li>**Recolher:** Extrai imediatamente o recurso prim√°rio da sua regi√£o.</li>
                        <li>**Negociar:** Troque recursos escassos por recursos mais abundantes ou vice-versa no mercado global.</li>
                        <li>**Colocar Explorador:** Posiciona uma unidade em uma regi√£o controlada (Nova A√ß√£o).</li>
                    </ul>
                </div>
                <div id="tab-estrategia" class="modal-section">
                    <h4>Dicas Estrat√©gicas</h4>
                    <ul>
                        <li>**Para Iniciantes:** Concentre-se em construir 2-3 regi√µes chave para garantir uma renda est√°vel.</li>
                        <li>**Para Avan√ßados:** Use o Ouro estrategicamente em negocia√ß√µes e explore regi√µes que outros jogadores precisam, for√ßando negocia√ß√µes.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Overlay para Customiza√ß√£o do Jogador -->
    <div class="modal-overlay" id="configOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configura√ß√µes de Fac√ß√£o</h2>
                <button class="modal-close" onclick="fecharConfig()">‚úñÔ∏è</button>
            </div>
            <div class="custom-selection">
                <p>Selecione a cor que representa sua Fac√ß√£o:</p>
                <div class="color-selector" id="colorSelector">
                    <!-- Op√ß√µes de Cor -->
                </div>

                <p>Selecione um √≠cone para sua unidade no mapa:</p>
                <div class="icon-selector" id="iconSelector">
                    <!-- Op√ß√µes de √çcone (Emojis) -->
                </div>
                
                <p>Nome de Exibi√ß√£o (Opcional):</p>
                <input type="text" id="displayNameInput" placeholder="Digite seu nome (ex: Fa√ß√£o Cobra)">
                <button class="btn btn-primary" onclick="salvarCustomizacao()">Salvar Configura√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs de debug do Firestore
        setLogLevel('Debug');

        // Vari√°veis Globais de Configura√ß√£o do Firebase (fornecidas pelo ambiente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // Vari√°veis de Estado do Jogo (Globals)
        window.jogador = {
            userId: null,
            nome: 'Carregando...',
            cor: '#a0a0a0', // Cor padr√£o (cinza)
            icone: 'üë§', // √çcone padr√£o
            recursos: { madeira: 10, pedra: 5, ouro: 2, agua: 5 },
            vp: 0,
            regioes: ['R1', 'R6', 'R11', 'R16', 'R21'], // Regi√µes iniciais (apenas para simula√ß√£o de controle)
            acaoRealizada: false,
        };
        window.turno = 0;
        window.mapa = {}; // Armazena a estrutura do mapa
        window.unidades = []; // Nova vari√°vel global para unidades
        window.jogadores = {}; // Armazena info de outros jogadores

        // --- Fun√ß√µes de Inicializa√ß√£o e Sincroniza√ß√£o Firebase ---

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase Configura√ß√£o ausente. Usando dados locais.");
                     // Se n√£o houver config, a simula√ß√£o continua com dados locais
                     inicializarJogoLocal();
                     return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await authenticateUser();
                
                // Iniciar listeners ap√≥s autentica√ß√£o
                onPlayersUpdate();
                onUnitsUpdate();
                
            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                // Fallback para modo local
                inicializarJogoLocal();
            }
        }
        
        async function authenticateUser() {
            return new Promise(async (resolve) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        window.jogador.userId = user.uid;
                        document.getElementById('user-id-display').textContent = user.uid;
                        console.log("Usu√°rio autenticado:", user.uid);
                        // Tentar carregar a customiza√ß√£o do jogador
                        await carregarCustomizacaoInicial(user.uid);
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    } else {
                         // Tenta autenticar com token ou anonimamente se o token n√£o estiver dispon√≠vel
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Erro ao assinar com token customizado. Tentando an√¥nimo.", e);
                                signInAnonymously(auth);
                            });
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            });
        }
        
        function getPlayerDocRef(userId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'players', userId);
        }
        
        function getUnitsCollectionRef() {
            return collection(db, 'artifacts', appId, 'public', 'data', 'units');
        }

        async function carregarCustomizacaoInicial(userId) {
            const playerDocRef = getPlayerDocRef(userId);
            try {
                const docSnap = await getDoc(playerDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.jogador.nome = data.nome || `Jogador ${userId.substring(0, 4)}`;
                    window.jogador.cor = data.cor || '#a0a0a0';
                    window.jogador.icone = data.icone || 'üë§';
                } else {
                    // Se o documento n√£o existir, salva os padr√µes iniciais
                    await salvarCustomizacao();
                }
            } catch (error) {
                console.error("Erro ao carregar customiza√ß√£o inicial:", error);
            }
        }
        
        // Listener para Jogadores (Customiza√ß√£o)
        function onPlayersUpdate() {
            if (!db || !isAuthReady) return;
            const playersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
            onSnapshot(playersColRef, (snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    window.jogadores[doc.id] = {
                        userId: doc.id,
                        nome: data.nome || `Jogador ${doc.id.substring(0, 4)}`,
                        cor: data.cor || '#a0a0a0',
                        icone: data.icone || 'üë§',
                        // Outras infos de jogador podem ser adicionadas aqui (ex: VP)
                    };
                });
                
                // Atualizar o jogador local com base no que veio do DB
                if (window.jogadores[currentUserId]) {
                    Object.assign(window.jogador, window.jogadores[currentUserId]);
                }
                atualizarDisplay();
                console.log("Jogadores Sincronizados:", window.jogadores);
            }, (error) => {
                console.error("Erro ao sincronizar jogadores:", error);
            });
        }
        
        // Listener para Unidades
        function onUnitsUpdate() {
            if (!db || !isAuthReady) return;
            const unitsColRef = getUnitsCollectionRef();
            onSnapshot(unitsColRef, (snapshot) => {
                window.unidades = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                atualizarMapa();
                console.log("Unidades Sincronizadas:", window.unidades);
            }, (error) => {
                console.error("Erro ao sincronizar unidades:", error);
            });
        }

        // --- Fun√ß√µes de Estado e Jogo ---

        function inicializarMapa() {
            const biomas = ['floresta', 'savana', 'pantano', 'temperada'];
            const regioes = {};
            const regioesIniciais = ['R1', 'R6', 'R11', 'R16', 'R21'];

            for (let i = 1; i <= 25; i++) {
                const id = `R${i}`;
                const bioma = biomas[Math.floor(Math.random() * biomas.length)];
                
                regioes[id] = {
                    id: id,
                    bioma: bioma,
                    controlador: regioesIniciais.includes(id) ? currentUserId : null, // Apenas simula√ß√£o
                    nivelExploracao: 0,
                };
            }
            window.mapa = regioes;
            atualizarMapa();
        }
        
        function inicializarJogoLocal() {
            // Chamado se o Firebase n√£o puder ser inicializado.
            currentUserId = 'local-user';
            window.jogador.userId = 'local-user';
            document.getElementById('user-id-display').textContent = 'MODO LOCAL';
            isAuthReady = true;
            
            inicializarMapa();
            atualizarDisplay();
            
            // Habilita bot√µes no modo local
            document.getElementById('endTurnBtn').disabled = false;
        }

        function iniciarNovoTurno() {
            window.turno++;
            // L√≥gica de Renda/Produ√ß√£o (simplificada)
            window.jogador.recursos.madeira += 5;
            window.jogador.recursos.pedra += 2;
            window.jogador.recursos.ouro += 1;

            window.jogador.acaoRealizada = false;
            
            habilitarAcoes();
            atualizarDisplay();
            atualizarMapa();
        }

        function passarTurno() {
            if (!window.jogador.acaoRealizada) {
                if (!confirm("Voc√™ n√£o realizou nenhuma a√ß√£o. Deseja passar o turno assim mesmo?")) {
                    return;
                }
            }
            // L√≥gica multiplayer real exigiria enviar uma transa√ß√£o de turno para o DB.
            desabilitarAcoes();
            iniciarNovoTurno();
        }

        function executarAcao(acao) {
            // A√ß√µes placeholder - Adicione a l√≥gica de custo e efeito
            let custoSuficiente = true;
            let mensagem = `A√ß√£o '${acao}' executada.`;

            if (acao === 'construir') {
                if (window.jogador.recursos.madeira < 5) {
                    custoSuficiente = false;
                    mensagem = 'Recursos insuficientes para Construir (5 Madeira).';
                } else {
                    window.jogador.recursos.madeira -= 5;
                    window.jogador.vp += 1;
                    mensagem = 'Estrutura constru√≠da! (+1 VP)';
                }
            } else if (acao === 'recolher') {
                window.jogador.recursos.madeira += 3;
                mensagem = 'Recursos recolhidos! (+3 Madeira)';
            } else if (acao === 'negociar') {
                 if (window.jogador.recursos.ouro < 1) {
                    custoSuficiente = false;
                    mensagem = 'Recursos insuficientes para Negociar (1 Ouro).';
                } else {
                    window.jogador.recursos.ouro -= 1;
                    window.jogador.recursos.agua += 2;
                    mensagem = 'Negocia√ß√£o conclu√≠da! (+2 √Ågua)';
                }
            }

            if (custoSuficiente) {
                window.jogador.acaoRealizada = true;
                desabilitarAcoes();
            }
            
            console.log(mensagem);
            atualizarDisplay();
        }
        
        // --- Fun√ß√µes de Unidade (Novo) ---
        
        async function colocarUnidade() {
            if (!currentUserId || !db) { console.error("Firebase n√£o pronto."); return; }
            if (window.jogador.recursos.madeira < 5) {
                console.log("Recursos insuficientes para colocar Explorador (5 Madeira).");
                return;
            }
            
            // Encontrar a primeira regi√£o controlada sem unidade para posicionamento simples
            const regiaoDisponivel = Object.values(window.mapa).find(reg => 
                reg.controlador === currentUserId && 
                !window.unidades.some(unit => unit.regionId === reg.id)
            );
            
            if (!regiaoDisponivel) {
                 console.log("N√£o h√° regi√µes controladas dispon√≠veis para colocar uma unidade.");
                return;
            }

            // Custear a a√ß√£o
            window.jogador.recursos.madeira -= 5;

            // Criar nova unidade no Firestore
            const newUnitId = `U-${Date.now()}`;
            const unitData = {
                regionId: regiaoDisponivel.id,
                userId: currentUserId,
                tipo: 'Explorador',
                posicao: 1, // Posi√ß√£o dentro da regi√£o, se necess√°rio
            };
            
            try {
                // O Firestore criar√° o documento com ID auto-gerado se usarmos addDoc. 
                // Usaremos setDoc com ID customizado para um controle mais simples.
                await setDoc(doc(getUnitsCollectionRef(), newUnitId), unitData);
                window.jogador.acaoRealizada = true;
                desabilitarAcoes();
                atualizarDisplay();
                console.log(`Unidade ${newUnitId} colocada na regi√£o ${regiaoDisponivel.id}`);
            } catch (error) {
                console.error("Erro ao salvar unidade:", error);
                window.jogador.recursos.madeira += 5; // Reverte custo
            }
        }

        // --- Fun√ß√µes de Display e Renderiza√ß√£o ---

        function atualizarDisplay() {
            // Atualiza o display de recursos
            document.getElementById('res-madeira').textContent = window.jogador.recursos.madeira;
            document.getElementById('res-pedra').textContent = window.jogador.recursos.pedra;
            document.getElementById('res-ouro').textContent = window.jogador.recursos.ouro;
            document.getElementById('res-agua').textContent = window.jogador.recursos.agua;
            
            // Atualiza o display de turno e VP
            document.getElementById('current-turn').textContent = window.turno;
            document.getElementById('player-vp').textContent = window.jogador.vp;
            
            // Atualiza o display do jogador
            document.getElementById('player-icon').textContent = window.jogador.icone;
            document.getElementById('player-icon').style.color = window.jogador.cor;
            document.getElementById('player-display-name').textContent = window.jogador.nome;
            
            // Revalida a habilita√ß√£o dos bot√µes
            habilitarAcoes();
        }

        function atualizarMapa() {
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = ''; // Limpa o mapa

            for (let i = 1; i <= 25; i++) {
                const id = `R${i}`;
                const regiao = window.mapa[id];
                const regionDiv = document.createElement('div');
                regionDiv.className = `region bioma-${regiao.bioma}`;
                regionDiv.id = `region-${id}`;

                let htmlContent = `<div class="region-id">${id}</div>`;
                htmlContent += `<small>(${regiao.bioma})</small>`;
                
                // Aplica a cor de controle se a regi√£o for controlada por um jogador conhecido
                if (regiao.controlador) {
                    const controlador = window.jogadores[regiao.controlador];
                    if (controlador) {
                        regionDiv.style.borderColor = controlador.cor;
                        regionDiv.classList.add('controlada');
                        
                        // Adiciona a identifica√ß√£o do controlador
                        htmlContent += `<div style="font-size: 0.7em; color: ${controlador.cor};">${controlador.nome.substring(0, 8)}</div>`;
                    }
                }
                
                // Adiciona o √≠cone da unidade
                const unidadeNaRegiao = window.unidades.find(unit => unit.regionId === id);
                if (unidadeNaRegiao) {
                    const unitController = window.jogadores[unidadeNaRegiao.userId];
                    if (unitController) {
                        htmlContent += `<span class="unit-icon" style="color: ${unitController.cor};">${unitController.icone}</span>`;
                    }
                }

                regionDiv.innerHTML = htmlContent;
                mapGrid.appendChild(regionDiv);
            }
        }
        
        function habilitarAcoes() {
            const acaoFeita = window.jogador.acaoRealizada;
            
            // Habilita/Desabilita a√ß√µes principais
            document.getElementById('construirBtn').disabled = acaoFeita || window.jogador.recursos.madeira < 5;
            document.getElementById('recolherBtn').disabled = acaoFeita;
            document.getElementById('negociarBtn').disabled = acaoFeita || window.jogador.recursos.ouro < 1;
            document.getElementById('placeUnitBtn').disabled = acaoFeita || window.jogador.recursos.madeira < 5 || !Object.values(window.mapa).some(reg => reg.controlador === currentUserId && !window.unidades.some(unit => unit.regionId === reg.id));

            // Habilita bot√£o de passar turno
            document.getElementById('endTurnBtn').disabled = false;
        }

        function desabilitarAcoes() {
            document.getElementById('construirBtn').disabled = true;
            document.getElementById('recolherBtn').disabled = true;
            document.getElementById('negociarBtn').disabled = true;
            document.getElementById('placeUnitBtn').disabled = true;
        }

        // --- Fun√ß√µes do Modal de Customiza√ß√£o ---
        
        const CORES = {
            'Verde': '#4CAF50',
            'Azul': '#2196F3',
            'Vermelho': '#F44336',
            'Amarelo': '#FFEB3B',
            'Ciano': '#00BCD4',
            'Roxo': '#9C27B0'
        };
        const ICONES = ['üëë', 'üê∫', 'üåø', '‚öôÔ∏è', 'üõ°Ô∏è', 'üåç'];

        function abrirConfig() {
            document.getElementById('configOverlay').classList.add('active');
            renderizarCustomizacao();
        }

        function fecharConfig() {
            document.getElementById('configOverlay').classList.remove('active');
        }
        
        function renderizarCustomizacao() {
            const colorSelector = document.getElementById('colorSelector');
            const iconSelector = document.getElementById('iconSelector');
            const currentCor = window.jogador.cor;
            const currentIcone = window.jogador.icone;
            
            document.getElementById('displayNameInput').value = window.jogador.nome === `Jogador ${currentUserId.substring(0, 4)}` ? '' : window.jogador.nome;

            // Renderizar Cores
            colorSelector.innerHTML = '';
            Object.values(CORES).forEach(cor => {
                const div = document.createElement('div');
                div.className = `color-option ${currentCor === cor ? 'selected' : ''}`;
                div.style.backgroundColor = cor;
                div.onclick = () => {
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    window.jogador.cor = cor;
                };
                colorSelector.appendChild(div);
            });
            
            // Renderizar √çcones
            iconSelector.innerHTML = '';
            ICONNES.forEach(icone => {
                const div = document.createElement('div');
                div.className = `icon-option ${currentIcone === icone ? 'selected' : ''}`;
                div.textContent = icone;
                div.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    window.jogador.icone = icone;
                };
                iconSelector.appendChild(div);
            });
        }
        
        async function salvarCustomizacao() {
            if (!currentUserId || !db) { console.error("Firebase n√£o pronto para salvar."); return; }
            
            const newNome = document.getElementById('displayNameInput').value.trim() || `Jogador ${currentUserId.substring(0, 4)}`;
            
            const dataToSave = {
                cor: window.jogador.cor,
                icone: window.jogador.icone,
                nome: newNome
            };
            
            try {
                await setDoc(getPlayerDocRef(currentUserId), dataToSave, { merge: true });
                window.jogador.nome = newNome; // Atualiza localmente com o nome novo
                atualizarDisplay();
                fecharConfig();
                console.log("Customiza√ß√£o salva com sucesso.");
            } catch (error) {
                console.error("Erro ao salvar customiza√ß√£o:", error);
            }
        }

        // --- Fun√ß√µes do Modal Manual (Original) ---

        function abrirManual() {
            document.getElementById('manualOverlay').classList.add('active');
        }

        function fecharManual() {
            document.getElementById('manualOverlay').classList.remove('active');
        }

        function mudarAba(abaId) {
            // Remove active de todas as abas
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.modal-section').forEach(section => {
                section.classList.remove('active');
            });

            // Adiciona active para a aba selecionada
            event.target.classList.add('active');
            document.getElementById(abaId).classList.add('active');
        }

        // --- Event Listeners e Inicializa√ß√£o ---

        document.getElementById('manualIcon').addEventListener('click', abrirManual);
        document.getElementById('configIcon').addEventListener('click', abrirConfig);
        document.getElementById('manualOverlay').addEventListener('click', function(e) {
            if (e.target === this) fecharManual();
        });
        document.getElementById('configOverlay').addEventListener('click', function(e) {
            if (e.target === this) fecharConfig();
        });

        // Inicializar Jogo e Firebase
        initFirebase().then(() => {
            // Se initFirebase for bem-sucedido e autenticado, iniciamos o jogo no primeiro turno
            if (isAuthReady) {
                inicializarMapa();
                iniciarNovoTurno(); // Inicia no Turno 1
                // Remove o loading overlay ap√≥s a autentica√ß√£o e carga inicial
                const loading = document.getElementById('loadingOverlayManual');
                if (loading) loading.style.display = 'none';
            }
        });
        
    </script>
</body>
</html>
