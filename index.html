<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaia Dominium - MVP (Integrado Firestore)</title>
    <!-- Tailwind CSS CDN para Estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fundo-dark': '#121212',
                        'superficie': '#1e1e1e',
                        'accent-verde': '#4CAF50',
                        'accent-bronze': '#c18a22',
                        'texto-claro': '#e0e0e0',
                        'map-floresta': '#2e7d32',
                        'map-savana': '#c0ca33',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos customizados para a est√©tica do jogo */
        .recurso-item {
            transition: all 0.2s ease-in-out;
        }
        .recurso-pulse {
            transform: scale(1.1);
            background-color: #4CAF50; /* Verde de destaque */
        }
        .map-region {
            transition: all 0.2s;
            cursor: pointer;
            @apply rounded-lg shadow-md border-2 border-transparent;
        }
        .map-region.selected {
            @apply border-accent-bronze border-4;
        }
        /* Estiliza√ß√£o para o Modal/Manual */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .modal-tab.active {
            @apply border-b-2 border-accent-bronze font-bold text-accent-bronze;
        }
        .loading-overlay {
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-fundo-dark text-texto-claro font-sans min-h-screen overflow-hidden">
    
    <!-- Loader para indicar que o Firebase est√° inicializando ou sincronizando -->
    <div id="loadingOverlay" class="loading-overlay fixed inset-0 flex items-center justify-center">
        <div class="flex flex-col items-center space-y-3">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-accent-verde"></div>
            <p class="text-lg font-semibold text-accent-verde">Conectando ao Dominium... Aguarde</p>
            <p class="text-sm text-texto-claro/50">Certifique-se de que as vari√°veis globais do Firebase est√£o carregadas.</p>
        </div>
    </div>

    <!-- Header com Logo e √çcone Manual -->
    <header class="fixed top-0 left-0 right-0 bg-superficie shadow-xl z-10 flex justify-between items-center h-14 px-4">
        <h1 class="text-xl font-bold text-accent-verde tracking-widest">GAIA DOMINIUM <span class="text-sm font-normal text-texto-claro/50">MVP</span></h1>
        <button id="manualIcon" class="p-2 rounded-full hover:bg-superficie/50 transition-colors">
            <!-- √çcone de Manual (livro) -->
            <svg class="w-6 h-6 text-accent-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.208 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.792 18 7.5 18s3.332.477 4.5 1.253M12 6.253C13.168 5.477 14.792 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.208 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
        </button>
    </header>

    <div class="flex pt-14 h-screen">
        
        <!-- COLUNA 1: PAINEL DE STATUS -->
        <aside class="w-1/4 p-4 bg-superficie overflow-y-auto flex flex-col space-y-6">
            <h2 class="text-lg font-semibold border-b border-gray-700 pb-2 text-accent-verde">üìä Status da Fac√ß√£o</h2>
            
            <!-- Contadores de Pontos de Vit√≥ria (A) -->
            <div id="pontosDisplay" class="space-y-4">
                <div class="space-y-1">
                    <p class="text-sm font-medium">Conserva√ß√£o (V. Verde): <span id="pontosConservacao" class="font-bold text-accent-verde">0</span></p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="barConservacao" class="bg-accent-verde h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-1">
                    <p class="text-sm font-medium">Dom√≠nio Militar (V. Vermelha): <span id="pontosMilitar" class="font-bold text-red-500">0</span></p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="barMilitar" class="bg-red-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-1">
                    <p class="text-sm font-medium">Produ√ß√£o Econ√¥mica (V. Amarela): <span id="pontosProducao" class="font-bold text-yellow-500">0</span></p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="barProducao" class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-700 pt-4">
                <h2 class="text-lg font-semibold pb-2 text-accent-verde">üí∞ Recursos Atuais</h2>
                <!-- Recursos Atuais (B) -->
                <div id="recursosDisplay" class="grid grid-cols-2 gap-4">
                    <div class="recurso-item bg-superficie/80 p-3 rounded-lg shadow-inner flex items-center space-x-2 border border-gray-600">
                        <span class="text-xl">üå≥</span>
                        <div class="text-sm">
                            <p class="font-light">Madeira Sustent√°vel</p>
                            <p id="recursoMadeira" class="font-bold text-texto-claro" data-recurso="madeira">0</p>
                        </div>
                    </div>
                    <div class="recurso-item bg-superficie/80 p-3 rounded-lg shadow-inner flex items-center space-x-2 border border-gray-600">
                        <span class="text-xl">üíß</span>
                        <div class="text-sm">
                            <p class="font-light">√Ågua Pura</p>
                            <p id="recursoAgua" class="font-bold text-texto-claro" data-recurso="agua">0</p>
                        </div>
                    </div>
                    <div class="recurso-item bg-superficie/80 p-3 rounded-lg shadow-inner flex items-center space-x-2 border border-gray-600">
                        <span class="text-xl">üí∞</span>
                        <div class="text-sm">
                            <p class="font-light">Cr√©ditos de Carbono</p>
                            <p id="recursoCredito" class="font-bold text-texto-claro" data-recurso="credito">0</p>
                        </div>
                    </div>
                    <div class="recurso-item bg-superficie/80 p-3 rounded-lg shadow-inner flex items-center space-x-2 border border-gray-600">
                        <span class="text-xl">üî¨</span>
                        <div class="text-sm">
                            <p class="font-light">Tecnologia Verde</p>
                            <p id="recursoTecnologia" class="font-bold text-texto-claro" data-recurso="tecnologia">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log de A√ß√µes (C) -->
            <div class="border-t border-gray-700 pt-4 flex-grow">
                <h2 class="text-lg font-semibold pb-2 text-accent-verde">üìú Log de A√ß√µes</h2>
                <div id="logDisplay" class="bg-fundo-dark p-3 text-sm h-40 overflow-y-auto rounded-lg border border-gray-700 space-y-1">
                    <!-- Logs ser√£o inseridos aqui -->
                </div>
            </div>
            
            <!-- Exibi√ß√£o do User ID para fins de debug/multiplayer -->
            <div class="border-t border-gray-700 pt-4">
                <p class="text-xs text-texto-claro/50">ID da Sess√£o (App/User): <span id="appUserId" class="font-mono text-xs text-accent-bronze">Aguardando Auth...</span></p>
            </div>

        </aside>

        <!-- COLUNA 2: MAPA E INTERA√á√ÉO -->
        <main class="w-1/2 p-4 flex flex-col items-center justify-center bg-fundo-dark">
            <h2 class="text-xl font-bold mb-4 text-accent-bronze">üó∫Ô∏è Mapa das Florestas de Gaia</h2>
            
            <!-- Indicador de Turno (G) -->
            <div id="turnoStatus" class="mb-6 p-3 bg-superficie/70 rounded-lg shadow-lg">
                <p class="text-lg font-semibold">Turno Atual: <span id="numTurno" class="text-accent-verde">0</span> | Jogador: <span id="jogadorAtual" class="text-accent-bronze">Aguardando Sincroniza√ß√£o...</span></p>
            </div>

            <!-- Mapa (E) -->
            <div id="mapaContainer" class="grid grid-cols-5 gap-3 aspect-square w-full max-w-xl shadow-2xl p-4 bg-superficie rounded-2xl border-4 border-gray-700">
                <!-- Regi√µes s√£o inseridas pelo JS -->
            </div>
            <p class="text-sm text-texto-claro/70 mt-4">Clique em uma regi√£o para selecion√°-la e ver detalhes.</p>
        </main>

        <!-- COLUNA 3: PAINEL DE A√á√ïES -->
        <aside class="w-1/4 p-4 bg-superficie overflow-y-auto flex flex-col space-y-6">
            <h2 class="text-lg font-semibold border-b border-gray-700 pb-2 text-accent-verde">üõ†Ô∏è A√ß√µes Modulares</h2>
            
            <!-- Bot√µes de A√ß√£o (H) -->
            <div id="acoesContainer" class="grid grid-cols-2 gap-3">
                <button id="moverBtn" class="acao-btn bg-accent-bronze hover:bg-accent-bronze/90 text-fundo-dark font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="iniciarAcao('Mover')" disabled>Mover/Sabotar</button>
                <button id="construirBtn" class="acao-btn bg-accent-bronze hover:bg-accent-bronze/90 text-fundo-dark font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="iniciarAcao('Construir')" disabled>Desenvolver/Com√©rcio</button>
                <button id="recolherBtn" class="acao-btn bg-accent-bronze hover:bg-accent-bronze/90 text-fundo-dark font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="iniciarAcao('Recolher')" disabled>Recolher/P&D</button>
                <button id="negociarBtn" class="acao-btn bg-accent-bronze hover:bg-accent-bronze/90 text-fundo-dark font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="iniciarAcao('Negociar')" disabled>Regra da Fac√ß√£o</button>
            </div>

            <!-- Bot√£o de Finalizar A√ß√£o -->
            <button id="finalizarAcaoBtn" class="w-full bg-accent-verde hover:bg-accent-verde/90 text-fundo-dark font-bold py-3 rounded-lg shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="finalizarAcao()" disabled>CONFIRMAR A√á√ÉO</button>
            
            <div class="border-t border-gray-700 pt-4">
                <h2 class="text-lg font-semibold pb-2 text-accent-verde">üÉè M√£o de Cartas</h2>
                <!-- Simula√ß√£o de M√£o de Cartas (I) -->
                <div id="cartasDisplay" class="grid grid-cols-3 gap-2 h-40 overflow-y-auto">
                    <div class="bg-gray-800 p-2 h-20 rounded-md text-xs border border-gray-600 flex items-center justify-center">Projeto B√°sico 1</div>
                    <div class="bg-gray-800 p-2 h-20 rounded-md text-xs border border-gray-600 flex items-center justify-center">Projeto B√°sico 2</div>
                    <div class="bg-gray-800 p-2 h-20 rounded-md text-xs border border-gray-600 flex items-center justify-center">Projeto B√°sico 3</div>
                    <div class="bg-gray-800 p-2 h-20 rounded-md text-xs border border-gray-600 flex items-center justify-center">Projeto B√°sico 4</div>
                </div>
            </div>

            <!-- Bot√£o Passar Turno (G) -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="endTurnBtn" class="w-full bg-red-700 hover:bg-red-600 text-texto-claro font-bold py-3 rounded-lg shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" onclick="passarTurno()" disabled>PASSE TURNO</button>
            </div>

        </aside>
    </div>

    <!-- Modal para o Manual do Jogo (Oculto para brevidade, mas mantido) -->
    <div id="modalOverlay" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <!-- Conte√∫do do Manual aqui (n√£o alterado da vers√£o anterior) -->
        <div class="bg-superficie w-11/12 max-w-3xl rounded-xl shadow-2xl p-6 relative">
            <h3 class="text-2xl font-bold mb-4 text-accent-bronze">Manual do Jogo: Gaia Dominium</h3>
            <button class="absolute top-4 right-4 text-texto-claro/70 hover:text-texto-claro" onclick="fecharManual()">&times;</button>
            
            <div class="flex border-b border-gray-700 mb-4">
                <button class="modal-tab p-2 transition-colors active" onclick="mudarAba('visaoGeral')">Vis√£o Geral</button>
                <button class="modal-tab p-2 transition-colors" onclick="mudarAba('regrasAcoes')">Regras & A√ß√µes</button>
                <button class="modal-tab p-2 transition-colors" onclick="mudarAba('dicasEstrategicas')">Estrat√©gia</button>
            </div>

            <div id="visaoGeral" class="modal-section active h-96 overflow-y-auto text-sm space-y-3">
                <p>Gaia Dominium √© um jogo de estrat√©gia digital que combina gerenciamento de recursos (*Eurogames*) e controle de √°rea (*Ameritrash*). Seu objetivo √© expandir o dom√≠nio florestal e acumular Pontos de Vit√≥ria em um dos tr√™s eixos: Conserva√ß√£o, Dom√≠nio Militar ou Produ√ß√£o Econ√¥mica.</p>
                <h4 class="font-semibold mt-3 text-accent-verde">Componentes Chave:</h4>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>**Fac√ß√µes Ass√≠metricas:** Cada jogador possui regras de vit√≥ria e habilidades √∫nicas.</li>
                    <li>**4 Recursos Vital√≠cios:** Madeira Sustent√°vel, √Ågua Pura, Cr√©ditos de Carbono e Tecnologia Verde.</li>
                    <li>**Mapa Florestal:** Um grid de 25 regi√µes onde a influ√™ncia e a explora√ß√£o s√£o disputadas.</li>
                </ul>
            </div>
            
            <div id="regrasAcoes" class="modal-section hidden h-96 overflow-y-auto text-sm space-y-3">
                <h4 class="font-semibold mt-3 text-accent-verde">Fases do Turno:</h4>
                <ul class="list-decimal list-inside space-y-1 ml-4">
                    <li>**1. Renda e Produ√ß√£o:** Renda de capital, projetos ativos e regi√µes controladas s√£o somadas automaticamente.</li>
                    <li>**2. Sele√ß√£o de A√ß√£o:** O jogador escolhe uma das quatro a√ß√µes modulares (Top/Bottom).</li>
                    <li>**3. Resolu√ß√£o:** Confirma√ß√£o da a√ß√£o e passagem de turno.</li>
                </ul>
                <h4 class="font-semibold mt-3 text-accent-verde">A√ß√µes Modulares:</h4>
                <p>O jogador s√≥ pode escolher uma a√ß√£o por turno. A escolha desabilita o bot√£o para o pr√≥ximo turno (simulado no MVP).</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>**Mover/Sabotar:** Move unidades / Realiza a√ß√£o de sabotagem em regi√µes vizinhas.</li>
                    <li>**Desenvolver/Com√©rcio:** Joga uma Carta de Projeto / Troca recursos no mercado.</li>
                    <li>**Recolher/P&D:** Aumenta a produ√ß√£o local / Adquire novas cartas de Projeto.</li>
                    <li>**Regra da Fac√ß√£o:** A√ß√£o especial exclusiva da fac√ß√£o atual.</li>
                </ul>
            </div>

            <div id="dicasEstrategicas" class="modal-section hidden h-96 overflow-y-auto text-sm space-y-3">
                <h4 class="font-semibold mt-3 text-accent-verde">Dicas para Iniciantes:</h4>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Priorize a obten√ß√£o de √Ågua Pura no in√≠cio, pois √© um recurso raro e valioso.</li>
                    <li>Use a a√ß√£o *Desenvolver* cedo para iniciar seu motor de produ√ß√£o.</li>
                </ul>
                <h4 class="font-semibold mt-3 text-accent-verde">Dicas para Avan√ßados:</h4>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Bloqueio de Regi√µes: Mantenha unidades em regi√µes estrat√©gicas que outros jogadores precisam.</li>
                    <li>Timing de Projetos: Ative projetos nos momentos certos para maximizar renda em turnos espec√≠ficos.</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- M√ìDULOS FIREBASE (TYPE="MODULE" √â ESSENCIAL) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis de escopo global para Firebase (necess√°rio para acesso pelas fun√ß√µes globais)
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.GAME_STATE_DOC = null;

        // Estado local (ser√° sincronizado pelo Firestore)
        window.gameState = {};
        window.recursos = {};
        window.pontos = {};
        
        // Caminho p√∫blico OBRIGAT√ìRIO para multiplayer: /artifacts/{appId}/public/data/{collection}/{docId}
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const GAME_PATH = `/artifacts/${appId}/public/data/gaiaDominiumGames/master`;

        // Configura√ß√£o do Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ----------------------------------------------------
        // 1. INICIALIZA√á√ÉO E AUTENTICA√á√ÉO
        // ----------------------------------------------------
        async function firebaseInit() {
            try {
                // Configura o n√≠vel de log para debug no console
                setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // Tenta autentica√ß√£o com o token customizado ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Espera a mudan√ßa de estado de autentica√ß√£o
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        
                        // Atualiza o display com o ID
                        document.getElementById('appUserId').textContent = `${appId} / ${window.userId.substring(0, 10)}...`;

                        // Define o documento de estado do jogo (p√∫blico)
                        window.GAME_STATE_DOC = doc(window.db, GAME_PATH);

                        // Inicia o listener de dados em tempo real
                        iniciarListener();

                    } else {
                        console.error("Autentica√ß√£o falhou ou usu√°rio deslogado.");
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar ou autenticar o Firebase:", error);
                document.getElementById('loadingOverlay').innerHTML = `<p class="text-red-500 text-lg">ERRO DE CONEX√ÉO: ${error.message}</p>`;
            }
        }
        
        // ----------------------------------------------------
        // 2. LISTENER DE DADOS (REAL-TIME)
        // ----------------------------------------------------
        function iniciarListener() {
            // onSnapshot: Escuta em tempo real o estado do jogo
            onSnapshot(window.GAME_STATE_DOC, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    // Sincroniza estados locais com o estado do banco
                    window.gameState = data.gameState || { turno: 1, jogador: 1, acaoExecutada: false };
                    window.recursos = data.recursos || { madeira: 0, agua: 0, credito: 0, tecnologia: 0 };
                    window.pontos = data.pontos || { conservacao: 0, militar: 0, producao: 0 };

                    console.log("Estado do jogo sincronizado (Turno:", window.gameState.turno, ")");
                    
                    // Atualiza a interface gr√°fica com os novos dados
                    window.atualizarDisplay();
                    
                    // Esconde o loader ap√≥s a primeira sincroniza√ß√£o
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    
                    // Habilita a jogabilidade
                    window.habilitarBotoes();

                } else {
                    // Se o documento n√£o existe, inicializa o jogo e salva no banco
                    console.log("Documento do jogo n√£o encontrado. Inicializando um novo jogo...");
                    window.inicializarNovoJogo();
                }
            }, (error) => {
                console.error("Erro no listener do Firestore:", error);
                // Exibe uma mensagem de erro na interface
                document.getElementById('loadingOverlay').innerHTML = `<p class="text-red-500 text-lg">ERRO DE SINCRONIZA√á√ÉO: ${error.code}</p>`;
            });
        }

        // ----------------------------------------------------
        // 3. SALVAR ESTADO DO JOGO (Persist√™ncia)
        // ----------------------------------------------------
        window.salvarEstado = async function() {
            if (!window.GAME_STATE_DOC) {
                console.error("Documento do jogo n√£o est√° pronto para salvar.");
                return;
            }
            try {
                // Usa setDoc para substituir o estado completo. Merge: true n√£o √© usado para garantir
                // que o estado do jogo seja sempre consistente.
                await setDoc(window.GAME_STATE_DOC, {
                    gameState: window.gameState,
                    recursos: window.recursos,
                    pontos: window.pontos
                });
                console.log("Estado do jogo salvo com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar o estado do jogo:", e);
                window.logAcao("ERRO: Falha ao salvar no banco de dados.");
            }
        }
        
        // ----------------------------------------------------
        // 4. L√ìGICA DE INICIALIZA√á√ÉO E CONTROLE
        // ----------------------------------------------------
        window.inicializarNovoJogo = async function() {
            window.gameState = {
                turno: 1,
                jogador: 1,
                acaoExecutada: false,
                regiaoSelecionada: null
            };
            window.recursos = {
                madeira: 5,
                agua: 2,
                credito: 5,
                tecnologia: 1
            };
            window.pontos = {
                conservacao: 10,
                militar: 5,
                producao: 15
            };
            
            window.logAcao("Novo jogo Gaia Dominium inicializado. Turno 1.");
            await window.salvarEstado();
        }

        window.habilitarBotoes = function() {
            // Habilita as a√ß√µes se n√£o houver a√ß√£o executada neste turno
            if (!window.gameState.acaoExecutada) {
                document.querySelectorAll('.acao-btn').forEach(btn => btn.disabled = false);
            } else {
                document.getElementById('finalizarAcaoBtn').disabled = false;
            }
            // O bot√£o de Passar Turno s√≥ √© habilitado ap√≥s finalizarAcao()
        }

        // Inicia a conex√£o do Firebase assim que o script for carregado
        firebaseInit();
    </script>
    
    <!-- JavaScript para a L√≥gica do Jogo (AGORA USANDO VARI√ÅVEIS GLOBAIS SINCRONIZADAS) -->
    <script>
        // Vari√°veis de Estado agora s√£o globais (window.gameState, window.recursos, etc.)
        
        // Dados Simples do Mapa (5x5 grid) - EST√ÅTICO, N√ÉO VAI PARA O FIREBASE
        const mapa = [
            // ... (Dados do mapa mantidos do arquivo anterior) ...
            { id: 1, nome: "Fl. Norte", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 2, nome: "Plan√≠cies", cor: "map-savana", producao: { credito: 1 } },
            { id: 3, nome: "Capital A", cor: "bg-green-700", producao: { agua: 1 } },
            { id: 4, nome: "Fl. Leste", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 5, nome: "Deserto", cor: "bg-yellow-800", producao: {} },
            
            { id: 6, nome: "Costa", cor: "bg-blue-600", producao: { agua: 1 } },
            { id: 7, nome: "Montanha", cor: "bg-gray-500", producao: { tecnologia: 1 } },
            { id: 8, nome: "Central", cor: "map-floresta", producao: { madeira: 1, agua: 1 } },
            { id: 9, nome: "P√¢ntano", cor: "bg-superficie/50", producao: { agua: 1 } },
            { id: 10, nome: "Plan√≠cies", cor: "map-savana", producao: { credito: 1 } },

            { id: 11, nome: "Fl. Oeste", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 12, nome: "Vales", cor: "map-savana", producao: { credito: 1 } },
            { id: 13, nome: "Capital B", cor: "bg-red-700", producao: { credito: 2 } },
            { id: 14, nome: "Fl. Sul", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 15, nome: "Tundra", cor: "bg-blue-200", producao: {} },

            { id: 16, nome: "Oceano", cor: "bg-blue-800", producao: { agua: 1 } },
            { id: 17, nome: "Plan√≠cies", cor: "map-savana", producao: { credito: 1 } },
            { id: 18, nome: "Capital C", cor: "bg-yellow-700", producao: { tecnologia: 1 } },
            { id: 19, nome: "Costa", cor: "bg-blue-600", producao: { agua: 1 } },
            { id: 20, nome: "Vulc√£o", cor: "bg-red-900", producao: { tecnologia: 1 } },

            { id: 21, nome: "Fl. Sul", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 22, nome: "Savana", cor: "map-savana", producao: { credito: 1 } },
            { id: 23, nome: "Fl. Leste", cor: "map-floresta", producao: { madeira: 1 } },
            { id: 24, nome: "Capital D", cor: "bg-purple-700", producao: { madeira: 1, credito: 1 } },
            { id: 25, nome: "Deserto", cor: "bg-yellow-800", producao: {} },
        ];


        // Fun√ß√£o para Inicializar o Mapa (APENAS HTML)
        function inicializarMapa() {
            const container = document.getElementById('mapaContainer');
            if (container.children.length === 0) { // Garante que o mapa s√≥ √© desenhado uma vez
                 mapa.forEach(regiao => {
                    const div = document.createElement('div');
                    div.id = `regiao-${regiao.id}`;
                    div.className = `map-region ${regiao.cor} hover:shadow-xl hover:scale-[1.03] flex items-center justify-center text-center text-xs p-1 h-16 transition-all`;
                    div.textContent = regiao.nome;
                    div.title = `Regi√£o: ${regiao.nome} (ID: ${regiao.id})`;
                    div.onclick = () => selecionarRegiao(regiao.id);
                    container.appendChild(div);
                });
            }
        }
        
        function selecionarRegiao(id) {
            // Remove a sele√ß√£o de todas as regi√µes
            document.querySelectorAll('.map-region').forEach(div => {
                div.classList.remove('selected');
            });

            // Adiciona a sele√ß√£o √† regi√£o clicada
            const regiaoDiv = document.getElementById(`regiao-${id}`);
            regiaoDiv.classList.add('selected');
            window.gameState.regiaoSelecionada = id;
            
            window.logAcao(`Regi√£o Selecionada: ${regiaoDiv.textContent}. Detalhes da Regi√£o...`);
        }

        window.logAcao = function(mensagem) {
            const logDisplay = document.getElementById('logDisplay');
            const p = document.createElement('p');
            p.className = 'text-texto-claro/80';
            p.innerHTML = `<span class="text-accent-bronze font-bold">[T${window.gameState.turno || 0}]</span> ${mensagem}`;
            logDisplay.prepend(p);
            if (logDisplay.children.length > 20) {
                logDisplay.removeChild(logDisplay.lastChild);
            }
        }

        // Atualiza a exibi√ß√£o de todos os estados (com anima√ß√£o)
        window.atualizarDisplay = function(recursoAlterado = null) {
            // 1. Atualizar Recursos
            document.getElementById('recursoMadeira').textContent = window.recursos.madeira || 0;
            document.getElementById('recursoAgua').textContent = window.recursos.agua || 0;
            document.getElementById('recursoCredito').textContent = window.recursos.credito || 0;
            document.getElementById('recursoTecnologia').textContent = window.recursos.tecnologia || 0;
            
            // Adiciona a anima√ß√£o de "pulse"
            if (recursoAlterado) {
                const recursoElement = document.getElementById(`recurso${recursoAlterado.charAt(0).toUpperCase() + recursoAlterado.slice(1)}`).parentElement;
                recursoElement.classList.add('recurso-pulse');
                setTimeout(() => {
                    recursoElement.classList.remove('recurso-pulse');
                }, 400);
            }

            // 2. Atualizar Pontos e Barras
            document.getElementById('pontosConservacao').textContent = window.pontos.conservacao || 0;
            document.getElementById('pontosMilitar').textContent = window.pontos.militar || 0;
            document.getElementById('pontosProducao').textContent = window.pontos.producao || 0;

            const maxPontos = 100;
            document.getElementById('barConservacao').style.width = `${Math.min(window.pontos.conservacao, maxPontos)}%`;
            document.getElementById('barMilitar').style.width = `${Math.min(window.pontos.militar, maxPontos)}%`;
            document.getElementById('barProducao').style.width = `${Math.min(window.pontos.producao, maxPontos)}%`;

            // 3. Atualizar Status do Turno
            document.getElementById('numTurno').textContent = window.gameState.turno || 0;
            document.getElementById('jogadorAtual').textContent = window.gameState.jogador === 1 ? 'Voc√™ (Fac√ß√£o Verde)' : 'IA/Jogador 2 (Fac√ß√£o Azul)';

            // 4. Status dos bot√µes de a√ß√£o
            const acaoBotoes = document.querySelectorAll('.acao-btn');
            acaoBotoes.forEach(btn => btn.disabled = window.gameState.acaoExecutada);
            document.getElementById('finalizarAcaoBtn').disabled = !window.gameState.acaoExecutada;
            document.getElementById('endTurnBtn').disabled = !window.gameState.acaoExecutada;
        }

        // Fase 1: Renda e Produ√ß√£o (Autom√°tica)
        async function calcularRenda() {
            window.logAcao("Fase 1: Calculando Renda e Produ√ß√£o...");
            
            // Renda Base (Simula√ß√£o)
            window.recursos.madeira += 2;
            window.recursos.agua += 1;
            
            // Renda de Regi√µes Controladas (Simula√ß√£o)
            mapa.forEach(regiao => {
                // Simula que regi√µes 3, 8, 11 e 14 s√£o controladas
                if ([3, 8, 11, 14].includes(regiao.id)) {
                    for (const [recursoNome, qtd] of Object.entries(regiao.producao)) {
                        window.recursos[recursoNome] += qtd;
                    }
                }
            });

            // Renda de Projetos (Simula√ß√£o)
            window.recursos.tecnologia += 1;
            window.pontos.producao += 3;
            
            window.logAcao("Renda coletada. Salvando no Firestore...");
            await window.salvarEstado(); // Salva as mudan√ßas de Renda no banco
        }

        // Fase 2: Sele√ß√£o da A√ß√£o Modular (H)
        async function iniciarAcao(acao) {
            if (window.gameState.acaoExecutada || !window.db) return; // Prote√ß√£o contra duplo clique e falta de DB
            
            let custoAtendido = true;
            
            // Simula√ß√£o de altera√ß√£o de estado ap√≥s a a√ß√£o
            switch (acao) {
                case 'Mover':
                    window.pontos.militar += 5;
                    window.logAcao(`A√ß√£o Modular: MOVER/SABOTAR - Foco em Dom√≠nio Militar. (+5 PV)`);
                    break;
                case 'Construir':
                    if (window.recursos.credito >= 3) {
                        window.recursos.credito -= 3;
                        window.pontos.conservacao += 5;
                        window.logAcao(`A√ß√£o Modular: DESENVOLVER/COM√âRCIO - Foco em Conserva√ß√£o. (-3 Cr√©ditos, +5 PV)`);
                    } else {
                        window.logAcao("Aviso: Cr√©ditos de Carbono insuficientes (req: 3). A√ß√£o cancelada.");
                        custoAtendido = false;
                    }
                    break;
                case 'Recolher':
                    window.recursos.madeira += 5;
                    window.pontos.producao += 5;
                    window.logAcao(`A√ß√£o Modular: RECOLHER/P&D - Foco em Produ√ß√£o. (+5 Madeira, +5 PV)`);
                    break;
                case 'Negociar':
                    if (window.recursos.tecnologia >= 1) {
                        window.recursos.tecnologia -= 1;
                        window.recursos.agua += 3;
                        window.logAcao(`A√ß√£o Modular: REGRA DA FAC√á√ÉO - Troca estrat√©gica. (-1 Tecnologia, +3 √Ågua Pura)`);
                    } else {
                        window.logAcao("Aviso: Tecnologia Verde insuficiente (req: 1). A√ß√£o cancelada.");
                        custoAtendido = false;
                    }
                    break;
            }

            if (custoAtendido) {
                window.gameState.acaoExecutada = true;
                await window.salvarEstado(); // Salva o estado da A√ß√£o no banco
            }
        }

        function finalizarAcao() {
            // Apenas habilita o bot√£o de passar turno, a l√≥gica de estado j√° est√° no Firestore
            if (window.gameState.acaoExecutada) {
                document.getElementById('endTurnBtn').disabled = false;
            }
            window.logAcao("A√ß√£o do Turno Finalizada. Pronto para a transi√ß√£o.");
        }

        // Fase 3: Passagem de Turno (G)
        async function passarTurno() {
            if (!window.gameState.acaoExecutada || !window.db) return;

            window.logAcao("--- IN√çCIO DO PR√ìXIMO TURNO ---");
            
            // 1. L√≥gica do Jogo
            window.gameState.turno++;
            window.gameState.jogador = window.gameState.jogador === 1 ? 2 : 1; // Alterna entre Jogador 1 e 2
            window.gameState.acaoExecutada = false;
            window.gameState.regiaoSelecionada = null;
            
            // 2. Aciona Renda e Produ√ß√£o para o novo turno
            await calcularRenda();
            
            // 3. Atualiza o estado do jogo no banco (o listener cuida do UI update)
            await window.salvarEstado(); 
            
            // 4. Se o pr√≥ximo jogador for a IA, simula um turno da IA (ap√≥s salvar)
            if (window.gameState.jogador === 2) {
                window.logAcao("Turno da IA (Fac√ß√£o Azul). Aguarde...");
                setTimeout(async () => {
                    // Simula uma a√ß√£o da IA
                    window.recursos.credito += 4;
                    window.pontos.conservacao += 2;
                    window.logAcao("IA executou a√ß√£o de Construir/Com√©rcio. Salvando...");
                    await window.salvarEstado(); // Salva o resultado da a√ß√£o da IA
                    
                    // A IA tamb√©m passa o turno
                    window.gameState.turno++;
                    window.gameState.jogador = 1; // Volta para o Jogador 1 (Voc√™)
                    window.gameState.acaoExecutada = false;
                    await calcularRenda(); // Calcula a renda para o pr√≥ximo turno do jogador
                    await window.salvarEstado();
                    
                    window.logAcao("Turno da IA finalizado. Sua vez!");
                }, 2000); // 2 segundos de espera
            }

            // O listener do Firestore vai atualizar a tela para todos os jogadores.
            
            // Desabilita o bot√£o de passar turno
            document.getElementById('endTurnBtn').disabled = true;
        }

        // Fun√ß√µes do Manual (n√£o dependem de estado)
        function abrirManual() { document.getElementById('modalOverlay').classList.remove('hidden'); }
        function fecharManual() { document.getElementById('modalOverlay').classList.add('hidden'); }
        function mudarAba(abaId) {
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.modal-section').forEach(section => section.classList.add('hidden'));
            document.querySelector(`[onclick="mudarAba('${abaId}')"]`).classList.add('active');
            document.getElementById(abaId).classList.remove('hidden');
        }

        // Event Listeners e Inicializa√ß√£o
        document.getElementById('manualIcon').addEventListener('click', abrirManual);
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) fecharManual();
        });
        document.addEventListener('DOMContentLoaded', () => {
             mudarAba('visaoGeral');
             inicializarMapa(); // Desenha o mapa est√°tico
             // O estado inicial do jogo e o display ser√£o carregados pelo listener do Firebase
        });
    </script>
</body>
</html>
