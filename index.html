<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaia Dominium - Multiplayer Local</title>
    <style>
        :root {
            --color-primary: #32b8c6;
            --color-primary-dark: #1d7480;
            --color-bg: #1a1a1a;
            --color-surface: #252525;
            --color-text: #e0e0e0;
            --color-text-secondary: #a0a0a0;
            --color-accent: #4caf50;
            --color-accent-dark: #2e7d31;
            --color-error: #f44336;
            --sidebar-width: 200px;
            --header-height: 50px;
            --action-panel-height: 90px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--color-surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primary);
        }

        .manual-icon {
            cursor: pointer;
            color: var(--color-text);
            font-size: 1.5rem;
            transition: color 0.2s;
        }
        .manual-icon:hover { color: var(--color-primary); }
        
        /* Informa√ß√µes do Jogador Atual no Header */
        #currentPlayerInfo {
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            gap: 10px;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: var(--color-bg);
        }
        #currentPlayerIcon {
            font-size: 1.5rem;
        }

        /* Painel Lateral (Status) */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            margin-top: var(--header-height);
            background-color: var(--color-surface);
            padding: 20px 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 5;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary-dark);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background-color: var(--color-bg);
            border-radius: 6px;
            font-size: 0.9rem;
            align-items: center;
        }

        .resource-item .label {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--color-text-secondary);
        }

        .resource-item .value {
            font-weight: bold;
            color: var(--color-text);
        }
        
        /* Lista de Jogadores */
        #playerListDisplay {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .player-score-item {
            display: flex;
            justify-content: space-between;
            padding: 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        .player-score-item.active-player {
            background-color: rgba(50, 184, 198, 0.2);
            border: 1px solid var(--color-primary);
        }

        /* √Årea Principal do Jogo (Mapa + A√ß√µes) */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-top: var(--header-height);
        }

        /* Visor de Feedback */
        #feedbackMessage {
            position: absolute;
            top: 50%;
            left: calc(var(--sidebar-width) + 50%);
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--color-text);
            text-align: center;
            z-index: 50;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            min-width: 400px;
        }

        #feedbackMessage.info { background-color: rgba(50, 184, 198, 0.9); }
        #feedbackMessage.success { background-color: rgba(76, 175, 80, 0.9); }
        #feedbackMessage.error { background-color: rgba(244, 67, 54, 0.9); }
        #feedbackMessage.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        /* Mapa */
        .game-map {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 3px;
            padding: 10px;
            background-color: var(--color-bg);
            position: relative;
            overflow: auto;
        }

        .region {
            background-color: var(--color-surface);
            border: 2px solid var(--color-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            border-radius: 6px;
        }

        .region:hover { background-color: #353535; }
        .region.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 10px var(--color-primary);
            transform: scale(1.02);
        }
        
        .region[data-player-color] {
            border-left: 5px solid var(--region-border-color, #fff);
        }

        .region-name { font-weight: bold; margin-bottom: 3px; color: var(--color-primary); }
        .region-info { font-size: 0.7rem; color: var(--color-text-secondary); }

        /* Painel de A√ß√µes (Barra inferior) */
        .action-panel {
            height: var(--action-panel-height);
            background-color: var(--color-surface);
            padding: 10px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
            z-index: 5;
            flex-shrink: 0;
        }

        .action-btn {
            background-color: var(--color-primary);
            color: var(--color-bg);
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px var(--color-primary-dark);
            position: relative;
            top: 0;
            min-width: 170px;
        }

        .action-btn:hover:not(:disabled) { background-color: var(--color-primary-dark); transform: translateY(-2px); box-shadow: 0 6px var(--color-primary-dark); }
        .action-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px var(--color-primary-dark); }
        .action-btn:disabled { background-color: #555; color: #aaa; cursor: not-allowed; box-shadow: 0 4px #444; }

        #endTurnBtn { background-color: var(--color-accent); box-shadow: 0 4px var(--color-accent-dark); }
        #endTurnBtn:hover:not(:disabled) { background-color: var(--color-accent-dark); box-shadow: 0 6px var(--color-accent-dark); }
        #endTurnBtn:active:not(:disabled) { box-shadow: 0 2px var(--color-accent-dark); }

        /* Tela Inicial de Configura√ß√£o de Jogadores (ConfigScreen) */
        .initial-screen {
            position: absolute;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; /* Acima da sidebar */
            gap: 20px;
            text-align: center;
            padding: 20px;
        }

        .initial-screen.hidden { display: none; }
        .initial-screen h1 { color: var(--color-primary); font-size: 2.5rem; }
        .initial-screen p { color: var(--color-text); font-size: 1.1rem; max-width: 600px; margin-bottom: 20px;}
        
        #playerSetupForm {
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
        }
        .player-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .player-input-group label {
            width: 100px;
            text-align: left;
            font-weight: bold;
        }
        .player-input-group input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #333;
            color: var(--color-text);
        }
        
        #playerCountDisplay {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: var(--color-accent);
        }

        /* Sele√ß√£o de √çcone */
        #iconSelection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .icon-option {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .icon-option.selected {
            border-color: var(--color-primary);
            background-color: rgba(50, 184, 198, 0.1);
        }

        .svg-icon { width: 24px; height: 24px; fill: currentColor; }
        
        /* Modal Manual */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 90vh;
        }
        .modal-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-primary-dark);
            color: white;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body {
            display: flex;
            flex-grow: 1;
        }
        .modal-sidebar {
            width: 150px;
            min-width: 150px;
            background-color: #333;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .modal-tab {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        .modal-tab:hover { background-color: #444; }
        .modal-tab.active { background-color: var(--color-primary); font-weight: bold; color: var(--color-bg); }
        .modal-main {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-section {
            display: none;
        }
        .modal-section.active {
            display: block;
        }
        .modal-section h4 {
            color: var(--color-primary);
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 1.2rem;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .modal-section p, .modal-section ul {
            margin-bottom: 10px;
            line-height: 1.5;
            color: var(--color-text-secondary);
        }
        .modal-section ul {
            list-style-type: disc;
            margin-left: 20px;
        }
        /* Fim Modal Manual */


        /* Responsive adjustments */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
                --header-height: 50px;
                --action-panel-height: 120px;
            }

            .container { flex-direction: column; }
            .header { justify-content: space-between; padding: 0 10px; }
            #currentPlayerInfo { font-size: 0.9rem; gap: 5px; }

            .sidebar {
                width: 100%;
                height: 120px; /* Maior para lista de PVs */
                margin-top: var(--header-height);
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
                align-items: flex-start;
                padding: 10px;
            }
            
            .sidebar h2 { width: 100%; text-align: center; } 
            
            #recursosDisplay, #pvSection {
                flex-grow: 1;
                width: 48%;
                max-width: 250px;
            }
            
            #playerListDisplay { gap: 2px; }
            .player-score-item { font-size: 0.8rem; padding: 4px; }
            
            .main-content {
                margin-top: calc(var(--header-height) + 120px);
                height: calc(100vh - var(--header-height) - 120px - var(--action-panel-height));
            }

            .action-panel {
                flex-wrap: wrap;
                height: var(--action-panel-height);
                gap: 5px;
                padding: 5px;
            }
            .action-btn {
                width: 48%;
                min-width: 0;
                padding: 8px;
                font-size: 0.9rem;
            }
            
            #feedbackMessage { left: 50%; min-width: 90%; font-size: 1rem; padding: 10px 15px; }

            .initial-screen {
                left: 0;
                top: var(--header-height);
                bottom: 0;
            }
            
            .modal-body { flex-direction: column; }
            .modal-sidebar { width: 100%; flex-direction: row; overflow-x: auto; flex-shrink: 0; }
            .modal-tab { min-width: 100px; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">Gaia Dominium</div>
        <!-- Informa√ß√µes do Jogador Atual -->
        <div id="currentPlayerInfo">
            <span id="currentPlayerIcon">‚ùì</span>
            <span id="currentPlayerName">Aguardando In√≠cio</span>
        </div>
        <div class="manual-icon" id="manualIcon">
            <!-- Livro Icone SVG -->
            <svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M18 2H6C4.9 2 4 2.9 4 4v16c0 1.1 0.9 2 2 2h12c1.1 0 2-0.9 2-2V4C20 2.9 19.1 2 18 2zM6 4h12v16H6V4zm7 14h-2v-2h2v2zm0-4h-2V7h2v7z"/>
            </svg>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar: Recursos e Pontos de Vit√≥ria -->
        <div class="sidebar">
            <h2 id="recursosTitle">Recursos (Jogador Atual)</h2>
            <div id="recursosDisplay">
                <!-- Conte√∫do atualizado por JS -->
            </div>
            <h2 id="pvTitle">Placar Global</h2>
            <div id="pvSection">
                <div class="resource-item">
                    <span class="label">Turno Atual:</span>
                    <span class="value" id="turnoDisplay">0</span>
                </div>
                <div id="playerListDisplay">
                    <!-- Lista de jogadores e PVs (atualizado por JS) -->
                </div>
            </div>
        </div>

        <!-- Main Content (√Årea do Mapa + Barra de A√ß√µes) -->
        <div class="main-content">
            <!-- Game Map -->
            <div class="game-map" id="gameMap">
                <!-- Regi√µes geradas por JS -->
            </div>

            <!-- Panel de A√ß√µes (Barra inferior fixa) -->
            <div class="action-panel">
                <button class="action-btn" id="construirBtn" onclick="executarAcao('Construir')" disabled>Construir (5 M, 2 P)</button>
                <button class="action-btn" id="recolherBtn" onclick="executarAcao('Recolher')" disabled>Recolher (1 M, 1 √Å)</button>
                <button class="action-btn" id="negociarBtn" onclick="executarAcao('Negociar')" disabled>Negociar (1 G, 1 PV)</button>
                <button class="action-btn" id="endTurnBtn" onclick="finalizarTurno()" disabled>Finalizar Turno</button>
            </div>
        </div>
    </div>
    
    <!-- Tela Inicial de Configura√ß√£o de Jogadores -->
    <div class="initial-screen" id="initialScreen">
        <h1>Configura√ß√£o de Partida</h1>
        <p>
            Esta √© uma partida multiplayer local (hotseat) para 2 a 4 jogadores. Cadastre os jogadores para come√ßar.
        </p>
        
        <div id="playerSetupForm">
            <div id="playerCountDisplay">0/4 Jogadores Registrados</div>
            
            <div class="player-input-group">
                <label for="playerName">Nome:</label>
                <input type="text" id="playerName" placeholder="Nome do Jogador">
            </div>

            <div class="player-input-group">
                <label>√çcone:</label>
                <div id="iconSelection">
                    <!-- √çcones gerados por JS -->
                </div>
            </div>

            <button class="action-btn" id="addPlayerBtn" onclick="adicionarJogador()">Adicionar Jogador</button>
            <button class="action-btn" id="startGameBtn" onclick="iniciarJogo()" disabled>Iniciar Jogo</button>
        </div>
    </div>

    <!-- Visor de Feedback Central -->
    <div id="feedbackMessage" class="feedback-message"></div>

    <!-- Modal Manual (mantido igual) -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manual do Jogo</h3>
                <button class="modal-close" onclick="fecharManual()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-sidebar">
                    <span class="modal-tab active" data-tab-id="visaoGeral" onclick="mudarAba('visaoGeral', event)">Vis√£o Geral</span>
                    <span class="modal-tab" data-tab-id="mecanicas" onclick="mudarAba('mecanicas', event)">Mec√¢nicas</span>
                    <span class="modal-tab" data-tab-id="acoes" onclick="mudarAba('acoes', event)">A√ß√µes</span>
                    <span class="modal-tab" data-tab-id="dicas" onclick="mudarAba('dicas', event)">Dicas</span>
                </div>
                <div class="modal-main">
                    <div class="modal-section active" id="visaoGeral">
                        <h4>Vis√£o Geral</h4>
                        <p>Gaia Dominium √© um jogo de estrat√©gia digital que combina gerenciamento de recursos e intera√ß√£o entre jogadores. O objetivo √© acumular Pontos de Vit√≥ria (PVs) para conquistar o planeta.</p>
                        <p>Cada jogador controla uma Fac√ß√£o com recursos iniciais (Madeira, Pedra, Ouro, √Ågua) e uma renda baseada em regi√µes e projetos ativos.</p>
                    </div>
                    <div class="modal-section" id="mecanicas">
                        <h4>Mec√¢nicas Principais</h4>
                        <p><strong>Ciclo de Turno:</strong> Cada turno come√ßa com a Fase de Renda (produ√ß√£o) e passa para a Fase de A√ß√£o.</p>
                        <p><strong>A√ß√£o √önica:</strong> Voc√™ s√≥ pode escolher e executar uma das tr√™s a√ß√µes principais (Construir, Recolher ou Negociar) por turno.</p>
                        <p><strong>Recursos:</strong> Madeira (M), Pedra (P), Ouro (G), √Ågua (√Å). Gerencie-os com sabedoria, pois o custo da a√ß√£o √© verificado *antes* da execu√ß√£o.</p>
                    </div>
                    <div class="modal-section" id="acoes">
                        <h4>A√ß√µes Dispon√≠veis</h4>
                        <ul>
                            <li><strong>Construir:</strong> Custo 5 Madeira, 2 Pedra. Adiciona uma estrutura, aumentando a renda e concedendo PVs.</li>
                            <li><strong>Recolher:</strong> Custo 1 Madeira, 1 √Ågua. Gasto menor, focado em produ√ß√£o e pequenos ganhos de PV.</li>
                            <li><strong>Negociar:</strong> Custo 1 Ouro. Converte recursos excedentes em recursos escassos ou PVs.</li>
                        </ul>
                    </div>
                    <div class="modal-section" id="dicas">
                        <h4>Dicas Estrat√©gicas</h4>
                        <p>Priorize a√ß√µes que fornecem PVs no in√≠cio. Use o Ouro (G) para negocia√ß√µes estrat√©gicas. Nunca se esque√ßa de clicar em "Finalizar Turno" ap√≥s sua a√ß√£o √∫nica.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Vari√°veis Globais de Estado (Armazenamento em RAM) ---
        let jogo = {
            turno: 0,
            players: [],
            currentPlayerIndex: 0, // √çndice do jogador atual no array 'players'
            regioes: [],
            acoesPermitidas: false,
            gameStarted: false
        };

        const mapSize = 5;
        const maxPlayers = 4;
        const regionNames = [
            "Bacia", "Pico", "Vale", "Delta", "Costa",
            "Clareira", "Bosque", "Brejo", "Montanha", "Litoral",
            "Rio", "Plan√≠cie", "Savana", "Deserto", "O√°sis",
            "Tundra", "Taiga", "Geleira", "Vulc√£o", "Fosso",
            "Reserva", "Floresta", "Lago", "Prado", "Caverna"
        ];
        
        const playerIcons = ['üî¥', 'üîµ', 'üü°', 'üü£', 'üü¢', 'üü§'];
        const playerColors = ['#F44336', '#2196F3', '#FFEB3B', '#9C27B0', '#4CAF50', '#795548'];

        // --- Fun√ß√µes de Utilit√°rios ---
        function mostrarFeedback(message, type = 'info', duration = 3000) {
            const feedbackEl = document.getElementById('feedbackMessage');
            feedbackEl.textContent = message;
            feedbackEl.className = `feedback-message ${type} show`;
            
            clearTimeout(feedbackEl.timeoutId);
            feedbackEl.timeoutId = setTimeout(() => {
                feedbackEl.classList.remove('show');
            }, duration);
        }

        function getEmoji(resource) {
            switch (resource) {
                case 'madeira': return 'üå≤';
                case 'pedra': return 'üóø';
                case 'ouro': return 'üí∞';
                case 'agua': return 'üíß';
                default: return '‚ùì';
            }
        }
        
        function getCurrentPlayer() {
            if (jogo.players.length === 0) return null;
            return jogo.players[jogo.currentPlayerIndex];
        }

        // --- Fun√ß√µes de Configura√ß√£o de Jogadores ---

        function renderizarIcones() {
            const selectionEl = document.getElementById('iconSelection');
            selectionEl.innerHTML = '';
            playerIcons.forEach(icon => {
                const span = document.createElement('span');
                span.classList.add('icon-option');
                span.textContent = icon;
                span.setAttribute('data-icon', icon);
                span.onclick = (event) => selecionarIcone(icon, event); // Passa o evento
                selectionEl.appendChild(span);
            });
            // Seleciona o primeiro por padr√£o
            selecionarIcone(playerIcons[0]);
        }

        function selecionarIcone(icon) { // Fun√ß√£o simplificada n√£o precisa do evento, mas vamos manter a chamada
            document.querySelectorAll('.icon-option').forEach(span => {
                span.classList.remove('selected');
            });
            const selectedIconEl = document.querySelector(`.icon-option[data-icon="${icon}"]`);
            if (selectedIconEl) {
                selectedIconEl.classList.add('selected');
            }
        }

        function adicionarJogador() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            const selectedIcon = document.querySelector('.icon-option.selected')?.getAttribute('data-icon');

            if (!name) {
                mostrarFeedback("O nome do jogador n√£o pode estar vazio.", 'error', 2000);
                return;
            }

            if (jogo.players.length >= maxPlayers) {
                mostrarFeedback(`M√°ximo de ${maxPlayers} jogadores atingido.`, 'error', 2000);
                return;
            }

            // Verifica se o √≠cone j√° est√° em uso
            if (jogo.players.some(p => p.icon === selectedIcon)) {
                mostrarFeedback("Este √≠cone j√° est√° em uso. Escolha outro.", 'error', 2000);
                return;
            }

            // Verifica se o nome j√° est√° em uso
            if (jogo.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                mostrarFeedback("Este nome j√° est√° em uso. Escolha outro.", 'error', 2000);
                return;
            }
            
            // Determina a cor com base no n√∫mero de jogadores (para visualiza√ß√£o de regi√£o)
            const colorIndex = jogo.players.length % playerColors.length;

            const newPlayer = {
                id: jogo.players.length + 1,
                name: name,
                icon: selectedIcon,
                color: playerColors[colorIndex],
                pv: 0,
                recursos: {
                    madeira: 10,
                    pedra: 5,
                    ouro: 3,
                    agua: 5
                },
                acoesPermitidas: true
            };

            jogo.players.push(newPlayer);
            nameInput.value = ''; // Limpa o campo de nome

            document.getElementById('playerCountDisplay').textContent = `${jogo.players.length}/${maxPlayers} Jogadores Registrados`;
            mostrarFeedback(`Jogador ${name} (${selectedIcon}) adicionado.`, 'success', 1500);

            // Habilita o bot√£o Iniciar Jogo se houver 2 ou mais jogadores
            if (jogo.players.length >= 2) {
                document.getElementById('startGameBtn').disabled = false;
            }
            
            // Desabilita o bot√£o Adicionar se atingir o m√°ximo
            if (jogo.players.length >= maxPlayers) {
                 document.getElementById('addPlayerBtn').disabled = true;
            }
            
            // Seleciona o pr√≥ximo √≠cone dispon√≠vel (se houver)
            const availableIcons = playerIcons.filter(icon => !jogo.players.some(p => p.icon === icon));
            if (availableIcons.length > 0) {
                 selecionarIcone(availableIcons[0]);
            }
        }

        // --- Fun√ß√µes de Jogo ---

        function inicializarMapa() {
            jogo.regioes = [];
            let playerIndex = 0;
            
            // L√≥gica simples para distribui√ß√£o inicial
            const regionsPerPlayer = Math.floor(mapSize * mapSize / jogo.players.length);
            
            for (let i = 0; i < mapSize * mapSize; i++) {
                // Roda o √≠ndice do jogador para distribuir
                const player = jogo.players[playerIndex % jogo.players.length];
                
                jogo.regioes.push({
                    id: i,
                    nome: regionNames[i],
                    bioma: ['Floresta', 'Savana', 'P√¢ntano', 'Tundra'][Math.floor(Math.random() * 4)],
                    controladorId: player.id, // O ID do jogador que controla a regi√£o
                    controladorCor: player.color,
                    nivelExploracao: 0
                });
                
                // Distribui as regi√µes uniformemente no in√≠cio
                // Aumenta o √≠ndice do jogador a cada 'regionsPerPlayer' regi√µes
                if (i < jogo.players.length * regionsPerPlayer - 1) { // Garante que n√£o ultrapasse o n√∫mero de jogadores antes do final
                    if ((i + 1) % regionsPerPlayer === 0) {
                        playerIndex++;
                    }
                }
            }
            renderizarMapa();
        }

        function renderizarMapa() {
            const mapEl = document.getElementById('gameMap');
            mapEl.innerHTML = '';
            jogo.regioes.forEach(regiao => {
                const regionEl = document.createElement('div');
                regionEl.classList.add('region');
                
                // Adiciona a cor do jogador como vari√°vel CSS para a borda lateral
                regionEl.style.setProperty('--region-border-color', regiao.controladorCor);
                regionEl.setAttribute('data-player-color', regiao.controladorCor);

                regionEl.innerHTML = `
                    <span class="region-name">${regiao.nome}</span>
                    <span class="region-info">${regiao.bioma}</span>
                    <span class="region-info">Expl.: ${regiao.nivelExploracao}</span>
                `;
                regionEl.addEventListener('click', () => selecionarRegiao(regiao.id));
                mapEl.appendChild(regionEl);
            });
        }

        function atualizarDisplay() {
            const currentPlayer = getCurrentPlayer();
            if (!currentPlayer) return;

            // 1. Header (Jogador Atual)
            document.getElementById('currentPlayerIcon').textContent = currentPlayer.icon;
            document.getElementById('currentPlayerName').textContent = currentPlayer.name;
            document.getElementById('recursosTitle').textContent = `Recursos (${currentPlayer.name})`;

            // 2. Recursos do Jogador Atual
            const recursosEl = document.getElementById('recursosDisplay');
            recursosEl.innerHTML = '';
            
            for (const [key, value] of Object.entries(currentPlayer.recursos)) {
                recursosEl.innerHTML += `
                    <div class="resource-item">
                        <span class="label">${getEmoji(key)} ${key.charAt(0).toUpperCase() + key.slice(1)}:</span>
                        <span class="value">${value}</span>
                    </div>
                `;
            }

            // 3. Placar Global (PVs)
            document.getElementById('turnoDisplay').textContent = jogo.turno;
            const playerListEl = document.getElementById('playerListDisplay');
            playerListEl.innerHTML = '';
            
            // Ordena os jogadores por PVs (do maior para o menor)
            const sortedPlayers = [...jogo.players].sort((a, b) => b.pv - a.pv);

            sortedPlayers.forEach(player => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('player-score-item');
                if (player.id === currentPlayer.id) {
                    itemEl.classList.add('active-player');
                }
                itemEl.innerHTML = `
                    <span>${player.icon} ${player.name}</span>
                    <span style="color: ${player.color}; font-weight: bold;">${player.pv} PV</span>
                `;
                playerListEl.appendChild(itemEl);
            });
            
            // Verifica a condi√ß√£o de vit√≥ria
            const winner = jogo.players.find(p => p.pv >= 25);
            if (winner) {
                mostrarFeedback(`üéâ Fim de Jogo! O Vencedor √©: ${winner.name} (${winner.icon}) com ${winner.pv} PVs!`, 'success', 10000);
                jogo.gameStarted = false;
                desabilitarBotoesAcao(true);
                document.getElementById('endTurnBtn').textContent = "Jogo Finalizado";
                document.getElementById('endTurnBtn').disabled = true;
            }
        }
        
        function desabilitarBotoesAcao(disabled) {
            document.getElementById('construirBtn').disabled = disabled;
            document.getElementById('recolherBtn').disabled = disabled;
            document.getElementById('negociarBtn').disabled = disabled;
        }

        function iniciarJogo() {
            if (jogo.players.length < 2) {
                mostrarFeedback("M√≠nimo de 2 jogadores para iniciar.", 'error', 3000);
                return;
            }
            
            // Oculta tela de configura√ß√£o
            document.getElementById('initialScreen').classList.add('hidden');
            jogo.gameStarted = true;
            
            // Inicializa mapa e define o primeiro jogador
            inicializarMapa();
            jogo.currentPlayerIndex = 0;
            
            // O primeiro "Finalizar Turno" se torna "Iniciar Turno"
            document.getElementById('endTurnBtn').textContent = `Iniciar Turno (Turno 1)`;
            document.getElementById('endTurnBtn').disabled = false;
            desabilitarBotoesAcao(true);

            atualizarDisplay();
            mostrarFeedback(`Partida iniciada com ${jogo.players.length} jogadores. Clique em 'Iniciar Turno' para come√ßar.`, 'info', 5000);
        }

        function iniciarTurno() {
            if (!jogo.gameStarted) return;
            
            jogo.turno++;
            
            const currentPlayer = getCurrentPlayer();
            
            // 1. Fase de Renda (Produ√ß√£o)
            // Renda base
            currentPlayer.recursos.madeira += 2;
            currentPlayer.recursos.pedra += 1;
            
            // Renda por Explora√ß√£o em regi√µes controladas
            const rendaExploracao = jogo.regioes.filter(r => r.controladorId === currentPlayer.id && r.nivelExploracao > 0).length;
            currentPlayer.recursos.madeira += rendaExploracao;
            currentPlayer.recursos.agua += rendaExploracao;

            // 2. Fase de A√ß√£o: Habilita bot√µes
            jogo.acoesPermitidas = true;
            desabilitarBotoesAcao(false);
            document.getElementById('endTurnBtn').disabled = true;
            document.getElementById('endTurnBtn').textContent = "Finalizar Turno";

            atualizarDisplay();
            mostrarFeedback(`Turno ${jogo.turno} - ${currentPlayer.name}. Renda recebida. Escolha UMA a√ß√£o.`, 'info', 4000);
        }

        function verificarCusto(acao, player) {
            let custo = {};
            switch (acao) {
                case 'Construir':
                    custo = { madeira: 5, pedra: 2 };
                    break;
                case 'Recolher':
                    custo = { madeira: 1, agua: 1 };
                    break;
                case 'Negociar':
                    custo = { ouro: 1 };
                    break;
                default:
                    return { podeExecutar: false, mensagem: "A√ß√£o desconhecida." };
            }

            let podeExecutar = true;
            let recursosFaltando = [];

            for (const [recurso, quantidade] of Object.entries(custo)) {
                if (player.recursos[recurso] < quantidade) {
                    podeExecutar = false;
                    recursosFaltando.push(`${quantidade} de ${recurso}`);
                }
            }

            if (!podeExecutar) {
                return { 
                    podeExecutar: false, 
                    mensagem: `Recursos insuficientes. Faltam: ${recursosFaltando.join(', ')}.`,
                    custo: custo
                };
            }

            return { podeExecutar: true, custo: custo };
        }

        function executarAcao(acao) {
            const currentPlayer = getCurrentPlayer();

            if (!jogo.acoesPermitidas || !currentPlayer) {
                mostrarFeedback("Por favor, clique em 'Iniciar Turno' ou 'Finalizar Turno'.", 'error');
                return;
            }

            const resultadoCusto = verificarCusto(acao, currentPlayer);

            if (!resultadoCusto.podeExecutar) {
                mostrarFeedback(resultadoCusto.mensagem, 'error', 4000);
                return;
            }

            // 1. Gasta recursos
            for (const [recurso, quantidade] of Object.entries(resultadoCusto.custo)) {
                currentPlayer.recursos[recurso] -= quantidade;
            }

            // 2. Aplica Efeito
            let mensagemEfeito = '';
            switch (acao) {
                case 'Construir':
                    currentPlayer.pv += 5;
                    // Exemplo: afeta a primeira regi√£o controlada
                    const controlledRegion = jogo.regioes.find(r => r.controladorId === currentPlayer.id);
                    if (controlledRegion) {
                        controlledRegion.nivelExploracao += 1;
                        mensagemEfeito = `Estrutura constru√≠da. +5 PV e +1 N√≠vel de Explora√ß√£o em ${controlledRegion.nome}.`;
                    } else {
                        mensagemEfeito = "Estrutura constru√≠da. +5 PV. (Nenhuma regi√£o controlada para explorar)";
                    }
                    renderizarMapa(); // Atualiza o mapa para refletir a explora√ß√£o
                    break;
                case 'Recolher':
                    currentPlayer.recursos.madeira += 4;
                    currentPlayer.recursos.pedra += 1;
                    currentPlayer.pv += 2;
                    mensagemEfeito = "Recursos recolhidos. +4 Madeira, +1 Pedra e +2 PV.";
                    break;
                case 'Negociar':
                    currentPlayer.recursos.pedra += 3;
                    currentPlayer.recursos.agua -= 1; 
                    currentPlayer.pv += 3;
                    mensagemEfeito = "Negocia√ß√£o conclu√≠da. Voc√™ ganhou +3 Pedra e +3 PV, mas gastou 1 √Ågua.";
                    break;
            }

            // 3. Bloqueia a√ß√µes e habilita Finalizar Turno
            jogo.acoesPermitidas = false;
            desabilitarBotoesAcao(true);
            document.getElementById('endTurnBtn').disabled = false;

            atualizarDisplay();
            mostrarFeedback(`‚úÖ ${acao} executada! ${mensagemEfeito} Agora, clique em 'Finalizar Turno'.`, 'success', 6000);
        }

        function finalizarTurno() {
            if (!jogo.gameStarted) return;
            
            const currentPlayer = getCurrentPlayer();
            
            // 1. Transi√ß√£o de Jogador (Hotseat)
            jogo.currentPlayerIndex = (jogo.currentPlayerIndex + 1) % jogo.players.length;
            const nextPlayer = getCurrentPlayer();
            
            // 2. Bloqueia a√ß√µes e prepara o bot√£o
            desabilitarBotoesAcao(true);
            document.getElementById('endTurnBtn').disabled = false;
            document.getElementById('endTurnBtn').textContent = `Passar para ${nextPlayer.name}`;

            // 3. Atualiza Display e Notifica Pr√≥ximo Jogador
            atualizarDisplay();
            // A√ß√£o de iniciar turno s√≥ ser√° chamada no clique do bot√£o ap√≥s esta finaliza√ß√£o
            document.getElementById('endTurnBtn').onclick = iniciarTurno;

            mostrarFeedback(`Turno de ${currentPlayer.name} finalizado. O pr√≥ximo √© ${nextPlayer.name} (${nextPlayer.icon}).`, 'info', 5000);
            
            // Se o √≠ndice voltou para 0, um novo ciclo de rodada come√ßou
            if (jogo.currentPlayerIndex === 0) {
                 document.getElementById('endTurnBtn').textContent = `Iniciar Turno (Rodada ${Math.floor(jogo.turno / jogo.players.length) + 1})`;
            }
        }

        function selecionarRegiao(regiaoId) {
            if (!jogo.gameStarted) {
                mostrarFeedback("Inicie o jogo primeiro!", 'error', 2000);
                return;
            }
            
            // L√≥gica de sele√ß√£o (mantida simples)
            document.querySelectorAll('.region').forEach(el => el.classList.remove('selected'));
            const regionEl = document.querySelectorAll('.region')[regiaoId];
            regionEl.classList.add('selected');
            
            const regiao = jogo.regioes[regiaoId];
            const controller = jogo.players.find(p => p.id === regiao.controladorId);
            
            mostrarFeedback(`Regi√£o ${regiao.nome} controlada por ${controller ? controller.name + ' (' + controller.icon + ')' : 'Ningu√©m'}.`, 'info', 2500);
        }

        // --- Fun√ß√µes Manuais (com corre√ß√£o) ---
        function abrirManual() {
            document.getElementById('modalOverlay').classList.add('active');
        }

        function fecharManual() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function mudarAba(abaId, event) {
            // Remove active de todas as abas
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.modal-section').forEach(section => {
                section.classList.remove('active');
            });

            // Adiciona active para a aba selecionada
            if(event && event.target) {
                event.target.classList.add('active');
            } else {
                 // Fallback: se n√£o tiver evento, tenta pelo ID
                 document.querySelector(`.modal-tab[data-tab-id="${abaId}"]`).classList.add('active');
            }

            document.getElementById(abaId).classList.add('active');
        }

        // Event Listeners e Inicializa√ß√£o
        document.getElementById('manualIcon').addEventListener('click', abrirManual);
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) fecharManual();
        });
        
        // Inicializa√ß√£o de Componentes
        renderizarIcones();
        atualizarDisplay(); // Inicializa os pain√©is com dados padr√µes
    </script>
</body>
</html>
